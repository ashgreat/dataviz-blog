---
title: "Donut Chart and Geofacets"
description: |
  In this post, I recreate the donut chart overlaid on geo facets. Based on a friend's feedback, I now add pictures of winners of each state.
author:
  - name: Ashwin Malshe
    url: www.ashwinmalshe.com
date: "2020-11-19"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(geofacet)

pacman::p_load(hrbrthemes, magick, cowplot, showtext, patchwork)

```

For the background and more details on this plot, please check out my earlier blog post: https://dataviz.school/posts/2020-11-20--us-election-donut/

## Getting the data

As of the date of this writing (21st November 2020), the results of the US Presidential elections have not tallied. The counting is still going on in a few states. However, it is unlikely that the results will change significantly from this point onward. I decided to get data from this Github repo, which scrapes data from NYT. The data is at county-level: https://github.com/favstats/USElection2020-NYT-Results


```{r}
# I saved the above data set as election-2020-21.rds
dt <- readRDS(here::here("election-2020-11-21.rds"))
```



```{r}

# Load the libraries
pacman::p_load(tidyverse, showtext, geofacet, cowplot)

dt2 <- dt %>% 
  mutate(
         Others = votes  - (results_trumpd + results_bidenj),
         Others_ab = absentee_votes - (results_absentee_trumpd + results_absentee_trumpd),
         state = stringr::str_replace_all(state, "-", " "),
         state = stringr::str_to_title(state),
         state = ifelse(state == "District Of Columbia", "District of Columbia",  state)
         ) %>% 
  group_by(state) %>% 
  summarize(Trump_votes = sum(results_trumpd, na.rm = TRUE),
            Trump_abvotes = sum(results_absentee_trumpd, na.rm = TRUE),
            Biden_votes = sum(results_bidenj, na.rm = TRUE),
            Biden_abvotes = sum(results_absentee_bidenj, na.rm = TRUE),
            Others_votes = sum(Others , na.rm = TRUE),
            Others_abvotes = sum(Others_ab , na.rm = TRUE),
            .groups = "drop") %>% 
  pivot_longer(cols = c(Trump_votes, Biden_votes, Others_votes,
                        Trump_abvotes, Biden_abvotes, Others_abvotes),
               names_to = c("Candidate", ".value"),
               names_pattern = "(.+)_(.+)") %>% 
  group_by(state) %>% 
    mutate(per_votes = votes / sum(votes)) %>% 
  ungroup()
  
```



```{r}
font_add("proxima", here::here("Icons", "ProximaNovaCond-Regular.otf"))
showtext_auto()
```


```{r}
dt3 <- dt2 %>%
  arrange(state, -votes) %>% 
  group_by(state) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(image = case_when(Candidate == "Biden" ~ "Images/joe-biden.png",
                           Candidate == "Trump" ~ "Images/donald-trump.png"),
         ymin = NA, ymax = NA)
```


```{r layout="l-body-outset", fig.width=11, fig.height=8.5}

g3 <- dt2 %>% 
  group_by(state) %>% 
  arrange(Candidate) %>% 
  mutate(ymax = cumsum(per_votes),
         ymin = ifelse(row_number() == 1, 0, lag(ymax)),
         ypos = (ymin + ymax) / 2,
                  ypos = ifelse(state == "District of Columbia" & Candidate == "Trump",
                       0.05, ypos)) %>% 
  ungroup() %>% 
  ggplot(aes(ymin = ymin, ymax = ymax, xmin = 3, xmax = 4)) +
  geom_rect(aes(fill = Candidate)) +
  geom_text(x = 1.8, 
             aes(y = ypos, 
                 label = formattable::percent(round(per_votes, 2), digits = 0)),
             size = 2, color = "white") +
  coord_polar(theta = "y") +
  facet_geo(~state) +
  # ggimage::geom_image(aes(x = 1, y = 0, image = image), data = dt3) +
  # annotation_raster(png::readPNG(here::here("Images", "joe-biden.png")), -Inf, Inf, -Inf, Inf) +
  scale_fill_manual(values = c("#0066f2", "#e6f1fd", "#ff0000")) +
  theme_void()+
  xlim(-1, 4) +
  labs(caption = "Ashwin Malshe \nhttps://dataviz.school",
       subtitle = " ") +
  theme(legend.text = element_text(family = "proxima", size = 10, color = "white"),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        legend.position = c(0.2, 1),
        plot.caption = element_text(family = "proxima", size = 10, hjust = 0.95,
                                    margin = margin(0, 0, 5, 0, "pt"),
                                    face = "bold", color = "#a3be8c"),
        strip.text = element_text(family = "proxima", size = 9, color = "white",
                                  margin = margin(0, 0, 5, 0, "pt")),
        plot.background = element_rect(fill = "#2e3440", color = NA),
        panel.background = element_rect(fill = "#2e3440", color = NA) )


# Print the plot

g3


```


```{r}
ggplot(dt3) +
  facet_geo(~state)

```




```{r echo=FALSE, eval=FALSE}
ggsave("state-donut4.png", plot = g3, dpi = 600, width = 11, height = 8.5)
```


<a target="_blank" href="https://icons8.com/icons/set/donald-trump">Donald Trump icon</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>

<a target="_blank" href="https://icons8.com/icons/set/joe-biden">Joe Biden icon</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>

